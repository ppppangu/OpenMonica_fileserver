# 知识库数据结构与触发器设计文档

## 1. 知识库系统抽象层次结构

知识库系统采用五层级联结构，从上到下依次为：

1. **用户层 (Users)**：系统的顶层实体，代表使用系统的个人或组织
2. **知识库层 (Knowledge Bases)**：用户创建的知识集合，用于组织相关文档
3. **文档层 (Documents)**：知识库中的具体文档，如文章、报告等
4. **组件层 (Components)**：文档的组成部分，统一管理文本块和图片
5. **基本元素层**：包括文本块 (Chunks) 和图片/表格 (Photos)

### 1.1 层次结构图

```
┌─────────┐
│  Users  │
└────┬────┘
     │ 1:N
     ▼
┌─────────────────┐
│ Knowledge Bases │
└────────┬────────┘
         │ 1:N
         ▼
┌─────────────┐
│  Documents  │
└──────┬──────┘
       │ 1:N
       ▼
┌─────────────┐
│ Components  │
└──────┬──────┘
       │ 1:1
       ▼
┌───────────────────┐
│ Chunks / Photos   │
└───────────────────┘
```

### 1.2 数据表关系

每个层次对应一个或多个数据表：

- **用户层**：`chunk_schema.users` 表
- **知识库层**：`chunk_schema.knowledge_bases` 表
- **文档层**：`chunk_schema.documents` 表
- **组件层**：`chunk_schema.components` 表
- **基本元素层**：`chunk_schema.chunks` 和 `chunk_schema.photos` 表

## 2. 核心需求

### 2.1 级联关系管理

**需求描述**：当插入下级元素时，上级元素应自动更新其索引数组；当删除上级元素时，所有下级元素应级联删除。

**具体表现**：
- 用户表中的 `knowledge_ids` 数组记录该用户拥有的所有知识库ID
- 知识库表中的 `document_ids` 数组记录该知识库包含的所有文档ID
- 文档表中的 `component_ids` 数组记录该文档包含的所有组件ID

### 2.2 组件层统一管理

**需求描述**：组件层作为中间层，统一管理文本块和图片，便于向量查询和文档内容管理。

**具体表现**：
- 文本块或图片插入时自动同步到组件表
- 组件表中的元素按 `doc_position` 排序，确保文档内容的正确顺序
- 组件表作为向量查询的统一入口

## 3. 数据操作与级联关系

### 3.1 插入操作

当在系统中插入新元素时，会触发自下而上的更新：

```
┌─────────┐
│  Users  │◄───┐
└────┬────┘    │
     │         │ 更新knowledge_ids
     ▼         │
┌─────────────────┐
│ Knowledge Bases │◄───┐
└────────┬────────┘    │
         │             │ 更新document_ids
         ▼             │
┌─────────────┐        │
│  Documents  │◄───┐   │
└──────┬──────┘    │   │
       │           │   │
       ▼           │   │
┌─────────────┐    │   │
│ Components  │◄───┼───┘
└──────┬──────┘    │
       │           │ 同步到Components
       ▼           │
┌───────────────────┐
│ Chunks / Photos   │───┘
└───────────────────┘
   插入新元素
```

#### 插入流程示例

1. 插入新的文本块 (Chunk)：
   - 文本块被插入到 `chunks` 表
   - 触发器自动在 `components` 表中创建对应记录
   - 触发器更新 `documents` 表中的 `component_ids` 数组
   - 组件的文本内容被合并更新到文档的 `text` 字段

### 3.2 删除操作

删除操作会触发自上而下的级联删除：

```
┌─────────┐
│  Users  │───┐
└────┬────┘   │
     │        │ 级联删除
     ▼        ▼
┌─────────────────┐
│ Knowledge Bases │───┐
└────────┬────────┘   │
         │            │ 级联删除
         ▼            ▼
┌─────────────┐       │
│  Documents  │───┐   │
└──────┬──────┘   │   │
       │          │   │
       ▼          ▼   │
┌─────────────┐   │   │
│ Components  │───┼───┘
└──────┬──────┘   │
       │          │ 级联删除
       ▼          ▼
┌───────────────────┐
│ Chunks / Photos   │
└───────────────────┘
```

#### 删除流程示例

1. 删除用户：
   - 用户被删除
   - 触发器级联删除该用户的所有知识库
   - 每个知识库的删除又触发其包含的所有文档的删除
   - 文档删除触发组件删除
   - 组件删除触发基本元素删除

2. 删除组件：
   - 组件被删除
   - 触发器从文档的 `component_ids` 中移除该组件ID
   - 触发器删除对应的文本块或图片
   - 触发器更新文档的 `text` 字段

### 3.3 更新操作

更新操作主要涉及元素所属关系的变更：

```
┌─────────┐
│  Users  │◄───┐
└────┬────┘    │
     │         │ 更新knowledge_ids
     ▼         │
┌─────────────────┐
│ Knowledge Bases │◄───┐
└────────┬────────┘    │
         │             │ 更新document_ids
         ▼             │
┌─────────────┐        │
│  Documents  │◄───┐   │
└──────┬──────┘    │   │
       │           │   │
       ▼           │   │
┌─────────────┐    │   │
│ Components  │◄───┼───┘
└──────┬──────┘    │
       │           │ 更新Components
       ▼           │
┌───────────────────┐
│ Chunks / Photos   │───┘
└───────────────────┘
   更新元素
```

#### 更新流程示例

1. 更新文档所属的知识库：
   - 文档的 `knowledge_base_id` 被更新
   - 触发器从旧知识库的 `document_ids` 中移除该文档ID
   - 触发器向新知识库的 `document_ids` 中添加该文档ID

## 4. 触发器设计

### 4.1 用户-知识库关联触发器

**触发器名称**：`knowledge_base_after_insert_update`, `knowledge_base_after_delete`  
**作用**：维护用户与知识库之间的关联  
**触发条件**：知识库创建、更新或删除时  
**执行函数**：`update_user_knowledge_uuids()`

```
┌─────────┐
│  Users  │◄───────────────┐
└─────────┘                │
                           │
┌─────────────────┐        │
│ Knowledge Bases │────────┘
└─────────────────┘
   触发器更新用户的knowledge_ids
```

### 4.2 知识库-文档关联触发器

**触发器名称**：`document_after_insert_update`, `document_after_delete`  
**作用**：维护知识库与文档之间的关联  
**触发条件**：文档创建、更新或删除时  
**执行函数**：`update_knowledge_base_document_ids()`

```
┌─────────────────┐
│ Knowledge Bases │◄───────────────┐
└─────────────────┘                │
                                   │
┌─────────────┐                    │
│  Documents  │────────────────────┘
└─────────────┘
   触发器更新知识库的document_ids
```

### 4.3 文档-组件关联触发器

**触发器名称**：`components_after_insert_update`, `components_after_delete`  
**作用**：维护文档与组件之间的关联  
**触发条件**：组件创建、更新或删除时  
**执行函数**：`update_document_component_ids()`

```
┌─────────────┐
│  Documents  │◄───────────────┐
└─────────────┘                │
                               │
┌─────────────┐                │
│ Components  │────────────────┘
└─────────────┘
   触发器更新文档的component_ids
```

### 4.4 组件-基本元素同步触发器

**触发器名称**：`chunks_after_insert_update`, `photos_after_insert_update`  
**作用**：将文本块和图片同步到组件表  
**触发条件**：文本块或图片创建或更新时  
**执行函数**：`sync_chunks_to_components()`, `sync_photos_to_components()`

```
┌─────────────┐
│ Components  │◄───────────────┐
└─────────────┘                │
                               │
┌───────────────────┐          │
│ Chunks / Photos   │──────────┘
└───────────────────┘
   触发器同步到组件表
```

### 4.5 组件删除触发器

**触发器名称**：`components_before_delete`  
**作用**：处理组件删除时的级联操作  
**触发条件**：组件被删除时  
**执行函数**：`handle_component_delete()`

```
┌─────────────┐
│ Components  │───────────────┐
└─────────────┘               │
                              ▼
┌───────────────────┐
│ Chunks / Photos   │
└───────────────────┘
   触发器删除对应的基本元素
```

### 4.6 基本元素删除触发器

**触发器名称**：`chunks_after_delete`, `photos_after_delete`  
**作用**：处理基本元素删除时的级联操作  
**触发条件**：文本块或图片被删除时  
**执行函数**：`handle_chunks_delete()`, `handle_photos_delete()`

```
┌─────────────┐
│ Components  │◄───────────────┐
└─────────────┘                │
                               │
┌───────────────────┐          │
│ Chunks / Photos   │──────────┘
└───────────────────┘
   触发器删除对应的组件
```

### 4.7 文档内容更新触发器

**触发器名称**：`components_after_content_change`  
**作用**：更新文档的文本内容  
**触发条件**：组件创建、更新或删除时  
**执行函数**：`update_document_content()`

```
┌─────────────┐
│  Documents  │◄───────────────┐
└─────────────┘                │
                               │
┌─────────────┐                │
│ Components  │────────────────┘
└─────────────┘
   触发器更新文档的text字段
```

### 4.8 组件位置唯一性触发器

**触发器名称**：`components_before_insert_update`  
**作用**：确保组件的位置唯一性和顺序性  
**触发条件**：组件创建或更新时  
**执行函数**：`ensure_doc_position_uniqueness()`

```
┌─────────────┐
│ Components  │
└─────────────┘
   触发器确保doc_position唯一
```

### 4.9 组件文本搜索触发器

**触发器名称**：`components_tsv_trigger`  
**作用**：更新组件的全文搜索索引  
**触发条件**：组件创建或更新时  
**执行函数**：`update_component_tsv()`

```
┌─────────────┐
│ Components  │
└─────────────┘
   触发器更新tsv字段
```

## 5. 完整业务流程

### 5.1 用户注册流程

```
┌──────────┐     ┌─────────┐
│  API层   │     │ 数据库层 │
└────┬─────┘     └────┬────┘
     │                │
     │ 创建用户请求    │
     │───────────────►│
     │                │
     │                │ 插入用户记录
     │                │◄──────────┐
     │                │           │
     │                │           │
     │ 返回用户信息    │           │
     │◄───────────────│           │
     │                │           │
┌────┴─────┐     ┌────┴────┐  ┌───┴───┐
│  API层   │     │ 数据库层 │  │ 用户表 │
└──────────┘     └─────────┘  └───────┘
```

**流程说明**：
1. API接收创建用户请求
2. 数据库插入新用户记录到`users`表
3. 返回用户信息给API

### 5.2 创建知识库流程

```
┌──────────┐     ┌─────────┐
│  API层   │     │ 数据库层 │
└────┬─────┘     └────┬────┘
     │                │
     │ 创建知识库请求  │
     │───────────────►│
     │                │
     │                │ 插入知识库记录
     │                │◄──────────┐
     │                │           │
     │                │ 触发器执行 │
     │                │◄──────────┼───────────┐
     │                │           │           │
     │ 返回知识库信息  │           │           │
     │◄───────────────│           │           │
     │                │           │           │
┌────┴─────┐     ┌────┴────┐  ┌───┴───┐  ┌────┴────┐
│  API层   │     │ 数据库层 │  │知识库表│  │ 用户表  │
└──────────┘     └─────────┘  └───────┘  └─────────┘
                                            ▲
                                            │
                                            │
                                  更新knowledge_ids数组
```

**流程说明**：
1. API接收创建知识库请求（必须包含用户ID）
2. 数据库插入新知识库记录到`knowledge_bases`表
3. 触发器`knowledge_base_after_insert_update`执行
4. 触发器函数`update_user_knowledge_uuids()`更新用户的`knowledge_ids`数组
5. 返回知识库信息给API

### 5.3 上传文档流程

```
┌──────────┐     ┌─────────┐
│  API层   │     │ 数据库层 │
└────┬─────┘     └────┬────┘
     │                │
     │ 上传文档请求    │
     │───────────────►│
     │                │
     │                │ 插入文档记录
     │                │◄──────────┐
     │                │           │
     │                │ 触发器执行 │
     │                │◄──────────┼───────────┐
     │                │           │           │
     │ 返回文档信息    │           │           │
     │◄───────────────│           │           │
     │                │           │           │
┌────┴─────┐     ┌────┴────┐  ┌───┴───┐  ┌────┴────┐
│  API层   │     │ 数据库层 │  │文档表 │  │知识库表 │
└──────────┘     └─────────┘  └───────┘  └─────────┘
                                            ▲
                                            │
                                            │
                                  更新document_ids数组
```

**流程说明**：
1. API接收上传文档请求（必须包含知识库ID）
2. 数据库插入新文档记录到`documents`表
3. 触发器`document_after_insert_update`执行
4. 触发器函数`update_knowledge_base_document_ids()`更新知识库的`document_ids`数组
5. 返回文档信息给API

### 5.4 上传文本块/图片流程

```
┌──────────┐     ┌─────────┐
│  API层   │     │ 数据库层 │
└────┬─────┘     └────┬────┘
     │                │
     │ 上传文本块请求  │
     │───────────────►│
     │                │
     │                │ 插入文本块记录
     │                │◄──────────┐
     │                │           │
     │                │ 触发器执行 │
     │                │◄──────────┼───────────┐
     │                │           │           │
     │                │ 触发器执行 │           │
     │                │◄──────────┼───────────┼───────────┐
     │                │           │           │           │
     │                │ 触发器执行 │           │           │
     │                │◄──────────┼───────────┼───────────┼───────────┐
     │                │           │           │           │           │
     │ 返回文本块信息  │           │           │           │           │
     │◄───────────────│           │           │           │           │
     │                │           │           │           │           │
┌────┴─────┐     ┌────┴────┐  ┌───┴───┐  ┌────┴────┐ ┌────┴────┐ ┌────┴────┐
│  API层   │     │ 数据库层 │  │文本块表│  │ 组件表  │ │ 文档表  │ │知识库表 │
└──────────┘     └─────────┘  └───────┘  └─────────┘ └─────────┘ └─────────