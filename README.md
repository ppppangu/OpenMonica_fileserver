# OpenMonica FileServer - AI Agent çŸ¥è¯†è®°å¿†ç³»ç»Ÿ

**ä¸ºAI Agentæä¾›"é˜…è¯»"å’Œ"è®°å¿†"èƒ½åŠ›** - è®©OpenMonicaèƒ½åƒäººç±»ä¸€æ ·ç†è§£æ–‡æ¡£ã€è®°ä½çŸ¥è¯†ã€å›å¿†ä¿¡æ¯

---

## ğŸ“– æ¨¡å—æ¦‚è¿°

**OpenMonica FileServer** æ˜¯OpenMonica AI Agentå¹³å°çš„**çŸ¥è¯†è®°å¿†å¼•æ“**ï¼Œèµ‹äºˆAIä»£ç†"é˜…è¯»ç†è§£"å’Œ"é•¿æœŸè®°å¿†"èƒ½åŠ›ã€‚å®ƒä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ–‡ä»¶å­˜å‚¨æœåŠ¡ï¼Œè€Œæ˜¯è®©AI Agentèƒ½å¤Ÿï¼š

- ğŸ“– **"é˜…è¯»"æ–‡æ¡£** - é€šè¿‡OCRå’Œå¤šæ¨¡æ€æ¨¡å‹ç†è§£PDFã€å›¾ç‰‡ã€è¡¨æ ¼ç­‰å„ç§æ ¼å¼
- ğŸ§  **"è®°ä½"çŸ¥è¯†** - å°†æ–‡æ¡£å†…å®¹å‘é‡åŒ–ï¼Œå­˜å‚¨ä¸ºAIå¯æ£€ç´¢çš„é•¿æœŸè®°å¿†
- ğŸ’¡ **"å›å¿†"ä¿¡æ¯** - é€šè¿‡å‘é‡æ£€ç´¢å’Œå…¨æ–‡æœç´¢ï¼Œè®©Agentåœ¨å¯¹è¯ä¸­å¿«é€Ÿæ‰¾åˆ°ç›¸å…³çŸ¥è¯†
- ğŸ”— **"å…³è”"æ¦‚å¿µ** - è‡ªåŠ¨æ„å»ºçŸ¥è¯†å›¾è°±ï¼Œå‘ç°æ–‡æ¡£é—´çš„å…³è”å…³ç³»

**æ ¸å¿ƒå®šä½**ï¼š
- ğŸ¤– **AI Agentçš„"å¤§è„‘"** - ä¸ºä¸ªäººåŠ©æ‰‹æä¾›çŸ¥è¯†åº“æ”¯æ’‘ï¼Œå¯¹æ ‡Monicaçš„çŸ¥è¯†ç®¡ç†èƒ½åŠ›
- ğŸ” **å¤šæ¨¡æ€ç†è§£** - ä¸åªæ˜¯æ–‡æœ¬ï¼Œè¿˜èƒ½"çœ‹æ‡‚"å›¾ç‰‡ã€å›¾è¡¨ã€æ‰‹å†™ç¬”è®°
- âš¡ **é«˜æ€§èƒ½å¤„ç†** - å¼‚æ­¥æ¶æ„ï¼Œæ”¯æŒå¤§è§„æ¨¡å¹¶å‘æ–‡æ¡£å¤„ç†ï¼ˆ1000+ docs/hourï¼‰
- ğŸ¢ **ä¼ä¸šçº§å­˜å‚¨** - é›†æˆMinIO/S3ï¼Œæ”¯æŒPBçº§æ–‡æ¡£å­˜å‚¨å’Œç®¡ç†

### æ ¸å¿ƒèƒ½åŠ›

- ğŸ“„ **å¤šæ ¼å¼æ”¯æŒ** - æ”¯æŒPDFã€DOCã€DOCXã€TXTã€MDã€å›¾ç‰‡ã€è¡¨æ ¼ç­‰20+ç§æ–‡æ¡£æ ¼å¼
- ğŸ” **OCRè¯†åˆ«** - é›†æˆMinerUå’ŒMistral AIå¤šæ¨¡æ€æ¨¡å‹ï¼Œé«˜ç²¾åº¦æ–‡æœ¬æå–
- ğŸ§® **å‘é‡åŒ–** - æ”¯æŒå¤šç§åµŒå…¥æ¨¡å‹ï¼ˆbge-m3ã€text-embeddingç­‰ï¼‰ï¼Œç”Ÿæˆé«˜è´¨é‡å‘é‡
- â˜ï¸ **å¯¹è±¡å­˜å‚¨** - é›†æˆMinIO/S3ï¼Œæ”¯æŒæµ·é‡æ–‡æ¡£å­˜å‚¨å’ŒCDNåŠ é€Ÿ
- ğŸ”„ **å¼‚æ­¥å¤„ç†** - åŸºäºå¼‚æ­¥é˜Ÿåˆ—çš„æ–‡æ¡£å¤„ç†ï¼Œæ”¯æŒé«˜å¹¶å‘åœºæ™¯
- ğŸ“Š **çŸ¥è¯†å›¾è°±** - è‡ªåŠ¨æ„å»ºæ–‡æ¡£é—´çš„å…³è”å…³ç³»å’ŒçŸ¥è¯†å›¾è°±
- ğŸ—„ï¸ **æ•°æ®åº“é›†æˆ** - ä¸PostgreSQLæ·±åº¦é›†æˆï¼Œæ”¯æŒå‘é‡æ£€ç´¢å’Œå…¨æ–‡æœç´¢

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph å®¢æˆ·ç«¯å±‚
        A[å‰ç«¯/APIå®¢æˆ·ç«¯]
    end

    subgraph æœåŠ¡å±‚
        B[FastAPI Server]
        C[æ–‡ä»¶ä¸Šä¼ å¤„ç†]
        D[OCRè¯†åˆ«æœåŠ¡]
        E[å‘é‡åŒ–æœåŠ¡]
        F[çŸ¥è¯†å›¾è°±ç”Ÿæˆ]
    end

    subgraph å­˜å‚¨å±‚
        G[(PostgreSQL<br/>å…ƒæ•°æ®+å‘é‡)]
        H[MinIO/S3<br/>æ–‡ä»¶å­˜å‚¨]
    end

    subgraph å¤–éƒ¨æœåŠ¡
        I[Convert2PDF<br/>æ ¼å¼è½¬æ¢]
        J[åµŒå…¥æ¨¡å‹<br/>API]
        K[å¤šæ¨¡æ€LLM<br/>OCR]
    end

    A --> B
    B --> C
    C --> H
    C --> I
    C --> D
    D --> K
    D --> E
    E --> J
    E --> G
    F --> G
    B --> G
```

### æ–‡æ¡£å¤„ç†æµç¨‹

```mermaid
sequenceDiagram
    participant C as å®¢æˆ·ç«¯
    participant FS as FileServer
    participant S3 as MinIO/S3
    participant C2P as Convert2PDF
    participant OCR as OCRæœåŠ¡
    participant EMB as åµŒå…¥æ¨¡å‹
    participant DB as PostgreSQL

    C->>FS: ä¸Šä¼ æ–‡ä»¶
    FS->>S3: å­˜å‚¨åŸå§‹æ–‡ä»¶
    FS->>C2P: è½¬æ¢ä¸ºPDF
    C2P->>S3: å­˜å‚¨PDFæ–‡ä»¶
    FS->>OCR: OCRæ–‡æœ¬æå–
    OCR->>FS: è¿”å›æ–‡æœ¬å’Œå¸ƒå±€
    FS->>EMB: ç”Ÿæˆå‘é‡åµŒå…¥
    EMB->>FS: è¿”å›å‘é‡
    FS->>DB: ä¿å­˜å…ƒæ•°æ®å’Œå‘é‡
    FS->>C: è¿”å›æ–‡æ¡£IDå’ŒçŠ¶æ€
```

---

## ğŸ“¦ ç›®å½•ç»“æ„

```
OpenMonica_fileserver/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ v1/                          # V1ç‰ˆæœ¬API
â”‚   â”‚   â”œâ”€â”€ main.py                  # FastAPIåº”ç”¨å…¥å£
â”‚   â”‚   â””â”€â”€ endpoints.py             # RESTful APIç«¯ç‚¹
â”‚   â””â”€â”€ legacy/                      # å…¼å®¹æ—§ç‰ˆæœ¬
â”‚       â”œâ”€â”€ main.py
â”‚       â”œâ”€â”€ endpoints.py
â”‚       â””â”€â”€ compatibility_adapter.py # é€‚é…å™¨
â”œâ”€â”€ src/
â”‚   â””â”€â”€ file_server_core/            # æ ¸å¿ƒåº“
â”‚       â”œâ”€â”€ models/                  # æ•°æ®æ¨¡å‹
â”‚       â”‚   â”œâ”€â”€ user.py
â”‚       â”‚   â”œâ”€â”€ knowledge_base.py
â”‚       â”‚   â”œâ”€â”€ document.py
â”‚       â”‚   â””â”€â”€ processing.py
â”‚       â”œâ”€â”€ server/                  # æœåŠ¡å™¨ç»„ä»¶
â”‚       â”‚   â”œâ”€â”€ server.py
â”‚       â”‚   â”œâ”€â”€ database.py          # æ•°æ®åº“ç®¡ç†
â”‚       â”‚   â”œâ”€â”€ file_manager.py
â”‚       â”‚   â””â”€â”€ storage.py
â”‚       â”œâ”€â”€ storage/                 # å­˜å‚¨ç®¡ç†
â”‚       â”‚   â””â”€â”€ manager.py
â”‚       â”œâ”€â”€ ocr/                     # OCRå¤„ç†
â”‚       â”‚   â”œâ”€â”€ base.py
â”‚       â”‚   â”œâ”€â”€ processor.py
â”‚       â”‚   â”œâ”€â”€ factory.py
â”‚       â”‚   â”œâ”€â”€ config/              # OCRé…ç½®
â”‚       â”‚   â””â”€â”€ providers/           # OCRæä¾›è€…
â”‚       â”‚       â””â”€â”€ mistral.py
â”‚       â”œâ”€â”€ parser/                  # æ–‡æ¡£è§£æ
â”‚       â”‚   â””â”€â”€ base.py
â”‚       â”œâ”€â”€ client/                  # å®¢æˆ·ç«¯SDK
â”‚       â”‚   â””â”€â”€ client.py
â”‚       â””â”€â”€ utils/                   # å·¥å…·å‡½æ•°
â”‚           â”œâ”€â”€ file_utils.py
â”‚           â””â”€â”€ config_utils.py
â”œâ”€â”€ scripts/                         # é—ç•™è„šæœ¬
â”‚   â”œâ”€â”€ mineru_process_legacy.py
â”‚   â”œâ”€â”€ graph_module_legacy.py
â”‚   â””â”€â”€ ...
â”œâ”€â”€ examples/                        # ä½¿ç”¨ç¤ºä¾‹
â”‚   â”œâ”€â”€ fast_start.py
â”‚   â””â”€â”€ async_cloud_usage_example.py
â”œâ”€â”€ docs/                            # æ–‡æ¡£
â”œâ”€â”€ .env.example                     # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ pyproject.toml                   # é¡¹ç›®é…ç½®
â”œâ”€â”€ setup.py                         # å®‰è£…è„šæœ¬
â””â”€â”€ README.md                        # æœ¬æ–‡ä»¶
```

---

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### 1. æ–‡ä»¶ä¸Šä¼ ä¸ç®¡ç†

**æ”¯æŒçš„æ–‡ä»¶ç±»å‹**ï¼š
- æ–‡æ¡£ï¼šPDF, DOC, DOCX, TXT, MD, RTF
- å›¾ç‰‡ï¼šPNG, JPG, JPEG, TIFF, BMP
- è¡¨æ ¼ï¼šXLS, XLSX, CSV
- å…¶ä»–ï¼šHTML, XML, JSON

**ä¸Šä¼ æ–¹å¼**ï¼š
- ç›´æ¥ä¸Šä¼ æ–‡ä»¶ï¼ˆmultipart/form-dataï¼‰
- é€šè¿‡URLä¸Šä¼ ï¼ˆè‡ªåŠ¨ä¸‹è½½ï¼‰

### 2. æ–‡æ¡£å¤„ç†æ¨¡å¼

#### Simpleæ¨¡å¼ï¼ˆå¿«é€Ÿï¼‰
- åŸºç¡€æ–‡æœ¬æå–ï¼Œä¸ä½¿ç”¨OCR
- é€‚ç”¨äºçº¯æ–‡æœ¬æ–‡æ¡£
- å¤„ç†é€Ÿåº¦å¿«ï¼Œèµ„æºå ç”¨å°‘

#### OCRæ¨¡å¼ï¼ˆæ ‡å‡†ï¼‰
- ä½¿ç”¨OCRæŠ€æœ¯æå–å›¾ç‰‡å’Œæ‰«ææ–‡æ¡£ä¸­çš„æ–‡å­—
- æ”¯æŒè¡¨æ ¼è¯†åˆ«å’Œå¸ƒå±€åˆ†æ
- é›†æˆMistral AIå¤šæ¨¡æ€æ¨¡å‹

#### Graphæ¨¡å¼ï¼ˆé«˜çº§ï¼‰
- æ„å»ºæ–‡æ¡£çŸ¥è¯†å›¾è°±
- æå–å®ä½“å…³ç³»
- æ”¯æŒæ–‡æ¡£é—´çš„è¯­ä¹‰å…³è”

### 3. å‘é‡åŒ–å¤„ç†

**åµŒå…¥æ¨¡å‹æ”¯æŒ**ï¼š
- bge-m3ï¼ˆä¸­è‹±æ–‡æ··åˆï¼‰
- text-embedding-ada-002ï¼ˆOpenAIï¼‰
- è‡ªå®šä¹‰åµŒå…¥æ¨¡å‹

**å‘é‡å­˜å‚¨**ï¼š
- å­˜å‚¨åˆ°PostgreSQLï¼ˆpgvectoræ‰©å±•ï¼‰
- æ”¯æŒå‘é‡ç›¸ä¼¼åº¦æœç´¢
- è‡ªåŠ¨åˆ›å»ºå‘é‡ç´¢å¼•

### 4. çŸ¥è¯†åº“ç®¡ç†

**å±‚çº§ç»“æ„**ï¼š
```
ç”¨æˆ· (User)
  â””â”€â”€ çŸ¥è¯†åº“ (Knowledge Base)
      â””â”€â”€ æ–‡æ¡£ (Document)
          â””â”€â”€ ç»„ä»¶ (Component)
              â”œâ”€â”€ æ–‡æœ¬å— (Chunk)
              â”œâ”€â”€ å›¾ç‰‡ (Photo)
              â””â”€â”€ è¡¨æ ¼ (Table)
```

**åŠŸèƒ½**ï¼š
- åˆ›å»º/åˆ é™¤çŸ¥è¯†åº“
- æ–‡æ¡£ä¸Šä¼ /åˆ é™¤
- æ–‡æ¡£åˆ—è¡¨æŸ¥è¯¢
- æ–‡æ¡£è¯¦æƒ…è·å–

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.11+
- PostgreSQL 16+ï¼ˆéœ€å®‰è£…pgvectoræ‰©å±•ï¼‰
- MinIOæˆ–AWS S3å…¼å®¹å­˜å‚¨
- uvåŒ…ç®¡ç†å·¥å…·ï¼ˆæ¨èï¼‰

### å®‰è£…æ­¥éª¤

```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repository-url>
cd OpenMonica_fileserver

# 2. å®‰è£…ä¾èµ–ï¼ˆä½¿ç”¨uvï¼‰
uv sync

# æˆ–ä½¿ç”¨pip
pip install -r requirements.txt

# 3. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
vim .env  # ç¼–è¾‘é…ç½®
```

### ç¯å¢ƒé…ç½®

åˆ›å»º`.env`æ–‡ä»¶ï¼š

```bash
# Mistral AIé…ç½®ï¼ˆOCRï¼‰
MISTRAL_API_KEY=your_mistral_api_key_here
MISTRAL_OCR_MODEL=mistral-ocr-latest

# PostgreSQLé…ç½®
PG_HOST=localhost
PG_PORT=5432
PG_DATABASE=postgres
PG_USER=postgres
PG_PASSWORD=your_password

# MinIOé…ç½®
MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY=your_access_key
MINIO_SECRET_KEY=your_secret_key
MINIO_BUCKET=openmonica
MINIO_SECURE=false

# åµŒå…¥æ¨¡å‹é…ç½®
EMBEDDING_MODEL_URL=http://localhost:8000
EMBEDDING_MODEL_KEY=your_api_key
EMBEDDING_MODEL_NAME=bge-m3

# Convert2PDFæœåŠ¡é…ç½®
CONVERT2PDF_URL=http://localhost:7758
```

### å¯åŠ¨æœåŠ¡

```bash
# å¼€å‘æ¨¡å¼ï¼ˆè‡ªåŠ¨é‡è½½ï¼‰
uv run uvicorn app.v1.main:app --host 0.0.0.0 --port 8087 --reload

# ç”Ÿäº§æ¨¡å¼
uv run uvicorn app.v1.main:app --host 0.0.0.0 --port 8087 --workers 4

# ä½¿ç”¨Gunicornï¼ˆç”Ÿäº§æ¨èï¼‰
gunicorn app.v1.main:app \
  --workers 4 \
  --worker-class uvicorn.workers.UvicornWorker \
  --bind 0.0.0.0:8087 \
  --timeout 300
```

### éªŒè¯éƒ¨ç½²

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8087/health

# è·å–æ”¯æŒçš„æ–‡ä»¶ç±»å‹
curl http://localhost:8087/v1/files/types
```

---

## ğŸ“š APIæ–‡æ¡£

### APIç‰ˆæœ¬

- **V1 API** - `/v1/*` - æ¨èä½¿ç”¨ï¼ŒRESTfulé£æ ¼
- **Legacy API** - `/legacy/*` - å…¼å®¹æ—§ç‰ˆæœ¬

### æ ¸å¿ƒç«¯ç‚¹

#### 1. å¥åº·æ£€æŸ¥

```http
GET /health
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "status": "ok"
}
```

---

#### 2. è·å–æ”¯æŒçš„æ–‡ä»¶ç±»å‹

```http
GET /v1/files/types
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "status": "success",
  "message": "Supported file types retrieved",
  "data": {
    "supported_file_types": [
      ".pdf", ".doc", ".docx", ".txt", ".md",
      ".jpg", ".jpeg", ".png", ".xls", ".xlsx"
    ]
  }
}
```

---

#### 3. ä¸Šä¼ æ–‡ä»¶

```http
POST /v1/files
Content-Type: multipart/form-data
```

**è¯·æ±‚å‚æ•°**ï¼š
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| file | File | æ˜¯ | ä¸Šä¼ çš„æ–‡ä»¶ |
| user_id | String | å¦ | ç”¨æˆ·IDï¼Œé»˜è®¤"default" |

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```bash
curl -X POST http://localhost:8087/v1/files \
  -F "file=@document.pdf" \
  -F "user_id=user-123"
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "status": "success",
  "message": "File uploaded successfully",
  "data": {
    "file_url": "https://minio.example.com/bucket/user-123/document.pdf",
    "file_id": "file_abc123",
    "mime_type": "application/pdf",
    "size": 1024567
  }
}
```

---

#### 4. å¤„ç†æ–‡ä»¶

```http
POST /v1/files/process
Content-Type: application/x-www-form-urlencoded
```

**è¯·æ±‚å‚æ•°**ï¼š
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| user_id | String | æ˜¯ | ç”¨æˆ·ID |
| file_url | String | æ˜¯ | æ–‡ä»¶URL |
| knowledge_base_id | String | å¦ | çŸ¥è¯†åº“ID |
| mode | String | å¦ | å¤„ç†æ¨¡å¼ï¼ˆsimple/normalï¼‰ï¼Œé»˜è®¤simple |

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```bash
curl -X POST http://localhost:8087/v1/files/process \
  -d "user_id=user-123" \
  -d "file_url=https://minio.example.com/bucket/user-123/document.pdf" \
  -d "knowledge_base_id=kb-001" \
  -d "mode=simple"
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "status": "success",
  "message": "File processed successfully",
  "data": {
    "user_id": "user-123",
    "knowledge_base_id": "kb-001",
    "mode": "simple",
    "file_url": "https://minio.example.com/bucket/user-123/document.pdf",
    "markdown_public_url": "https://minio.example.com/bucket/processed/document.md",
    "pdf_file_public_url": "https://minio.example.com/bucket/processed/document.pdf",
    "file_uuid": "uuid-abc-123"
  }
}
```

---

#### 5. åˆ é™¤æ–‡ä»¶

```http
DELETE /v1/files/{file_id}
Content-Type: application/x-www-form-urlencoded
```

**è·¯å¾„å‚æ•°**ï¼š
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| file_id | String | æ–‡ä»¶ID |

**è¯·æ±‚å‚æ•°**ï¼š
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| user_id | String | æ˜¯ | ç”¨æˆ·ID |
| knowledge_base_id | String | å¦ | çŸ¥è¯†åº“ID |

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```bash
curl -X DELETE http://localhost:8087/v1/files/file-123 \
  -d "user_id=user-123" \
  -d "knowledge_base_id=kb-001"
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "status": "success",
  "message": "File deleted successfully"
}
```

---

#### 6. çŸ¥è¯†åº“å›¾è°±ç®¡ç†

```http
POST /v1/knowledge-bases/{knowledge_base_id}/graph
Content-Type: application/x-www-form-urlencoded
```

**è·¯å¾„å‚æ•°**ï¼š
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| knowledge_base_id | String | çŸ¥è¯†åº“ID |

**è¯·æ±‚å‚æ•°**ï¼š
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| user_id | String | æ˜¯ | ç”¨æˆ·ID |
| mode | String | æ˜¯ | æ“ä½œæ¨¡å¼ï¼ˆproduce/getï¼‰ |
| level | String | æ˜¯ | å›¾è°±å±‚çº§ï¼ˆdocument/subjectï¼‰ |

**ç”Ÿæˆæ–‡æ¡£å›¾è°±**ï¼š
```bash
curl -X POST http://localhost:8087/v1/knowledge-bases/kb-001/graph \
  -d "user_id=user-123" \
  -d "mode=produce" \
  -d "level=document"
```

**è·å–æ–‡æ¡£å›¾è°±**ï¼š
```bash
curl -X POST http://localhost:8087/v1/knowledge-bases/kb-001/graph \
  -d "user_id=user-123" \
  -d "mode=get" \
  -d "level=document"
```

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### Pythonå®¢æˆ·ç«¯ç¤ºä¾‹

#### 1. åŸºç¡€ä¸Šä¼ 

```python
import httpx
from pathlib import Path

async def upload_file(file_path: str, user_id: str):
    """ä¸Šä¼ æ–‡ä»¶åˆ°FileServer"""
    url = "http://localhost:8087/v1/files"

    with open(file_path, "rb") as f:
        files = {"file": (Path(file_path).name, f)}
        data = {"user_id": user_id}

        async with httpx.AsyncClient() as client:
            response = await client.post(url, files=files, data=data)
            return response.json()

# ä½¿ç”¨ç¤ºä¾‹
result = await upload_file("document.pdf", "user-123")
print(f"Uploaded: {result['data']['file_url']}")
```

#### 2. æ–‡æ¡£å¤„ç†

```python
async def process_document(
    user_id: str,
    file_url: str,
    knowledge_base_id: str,
    mode: str = "simple"
):
    """å¤„ç†æ–‡æ¡£"""
    url = "http://localhost:8087/v1/files/process"

    data = {
        "user_id": user_id,
        "file_url": file_url,
        "knowledge_base_id": knowledge_base_id,
        "mode": mode
    }

    async with httpx.AsyncClient(timeout=300) as client:
        response = await client.post(url, data=data)
        return response.json()

# ä½¿ç”¨ç¤ºä¾‹
result = await process_document(
    user_id="user-123",
    file_url="https://minio.example.com/bucket/document.pdf",
    knowledge_base_id="kb-001",
    mode="simple"
)
print(f"Document UUID: {result['data']['file_uuid']}")
```

#### 3. æ‰¹é‡ä¸Šä¼ 

```python
import asyncio
from pathlib import Path

async def batch_upload(directory: str, user_id: str, knowledge_base_id: str):
    """æ‰¹é‡ä¸Šä¼ ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶"""
    files = Path(directory).glob("**/*.*")

    async def upload_and_process(file_path):
        # ä¸Šä¼ 
        upload_result = await upload_file(str(file_path), user_id)
        file_url = upload_result["data"]["file_url"]

        # å¤„ç†
        process_result = await process_document(
            user_id, file_url, knowledge_base_id
        )
        return process_result

    tasks = [upload_and_process(f) for f in files if f.is_file()]
    results = await asyncio.gather(*tasks)
    return results

# ä½¿ç”¨ç¤ºä¾‹
results = await batch_upload("./documents", "user-123", "kb-001")
print(f"Processed {len(results)} documents")
```

---

## ğŸ—„ï¸ æ•°æ®åº“Schema

### PostgreSQLè¡¨ç»“æ„

FileServerä½¿ç”¨ä»¥ä¸‹æ•°æ®è¡¨ï¼ˆç”±`server/database.py`åˆ›å»ºï¼‰ï¼š

#### usersè¡¨
```sql
CREATE TABLE IF NOT EXISTS users (
    id VARCHAR(50) PRIMARY KEY,
    username VARCHAR(100) UNIQUE NOT NULL,
    email VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### knowledge_basesè¡¨
```sql
CREATE TABLE IF NOT EXISTS knowledge_bases (
    id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    user_id VARCHAR(50) REFERENCES users(id) ON DELETE CASCADE,
    settings JSONB DEFAULT '{}',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### documentsè¡¨
```sql
CREATE TABLE IF NOT EXISTS documents (
    id VARCHAR(50) PRIMARY KEY,
    filename VARCHAR(500) NOT NULL,
    original_filename VARCHAR(500) NOT NULL,
    file_size BIGINT NOT NULL,
    mime_type VARCHAR(100),
    file_hash VARCHAR(64),
    knowledge_base_id VARCHAR(50) REFERENCES knowledge_bases(id) ON DELETE CASCADE,
    user_id VARCHAR(50) REFERENCES users(id) ON DELETE CASCADE,
    storage_path TEXT,
    ocr_status VARCHAR(20) DEFAULT 'pending',
    ocr_result JSONB,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### document_processingè¡¨
```sql
CREATE TABLE IF NOT EXISTS document_processing (
    id SERIAL PRIMARY KEY,
    document_id VARCHAR(50) REFERENCES documents(id) ON DELETE CASCADE,
    processing_type VARCHAR(50) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    result JSONB,
    error_message TEXT,
    started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP
);
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### config.yamlé…ç½®æ–‡ä»¶

```yaml
# æœåŠ¡å™¨ç»„ä»¶é…ç½®
server_components:
  # PostgreSQLå‘é‡æ•°æ®åº“
  pg_vector:
    host: "localhost"
    port: 5432
    user: "postgres"
    password: "your_password"
    database: "postgres"
    active: true
    min_pool_size: 5
    max_pool_size: 20

  # MinIOå¯¹è±¡å­˜å‚¨
  minio:
    host: "localhost"
    port: 9000
    access_key: "your_access_key"
    secret_key: "your_secret_key"
    bucket_name: "openmonica"
    region: "us-east-1"
    active: true
    public_url_prefix: "https://cdn.example.com"  # CDNåŠ é€Ÿå‰ç¼€

  # Convert2PDFæœåŠ¡
  convert_format_server:
    - url: "http://localhost:7758"
      active: true

# APIé…ç½®
api:
  # è¯­è¨€åµŒå…¥æ¨¡å‹
  language_embedding:
    - name: "bge-m3"
      url: "http://localhost:8000/v1/embeddings"
      key: "your_api_key"
      alias: "bge-m3"
      dimension: 1024

  # å¤šæ¨¡æ€å¤§æ¨¡å‹ï¼ˆOCRï¼‰
  multimodal_llm:
    - name: "Qwen/Qwen2.5-VL-32B-Instruct"
      url: "http://localhost:8001/v1"
      key: "your_api_key"
      alias: "Qwen2.5-VL-32B-Instruct"
```

---

## ğŸ³ Dockeréƒ¨ç½²

### Dockerfile

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY . .

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir -e .

# æš´éœ²ç«¯å£
EXPOSE 8087

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "app.v1.main:app", "--host", "0.0.0.0", "--port", "8087"]
```

### docker-compose.yaml

```yaml
version: '3.8'

services:
  fileserver:
    build: .
    container_name: openmonica-fileserver
    ports:
      - "8087:8087"
    environment:
      - MISTRAL_API_KEY=${MISTRAL_API_KEY}
      - PG_HOST=postgres
      - PG_PORT=5432
      - PG_DATABASE=postgres
      - PG_USER=postgres
      - PG_PASSWORD=${PG_PASSWORD}
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
    volumes:
      - ./config.yaml:/app/config.yaml
    depends_on:
      - postgres
      - minio
    networks:
      - openmonica-network

  postgres:
    image: postgres:16
    container_name: openmonica-postgres
    environment:
      - POSTGRES_PASSWORD=${PG_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - openmonica-network

  minio:
    image: minio/minio
    container_name: openmonica-minio
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data
    networks:
      - openmonica-network

volumes:
  postgres-data:
  minio-data:

networks:
  openmonica-network:
    driver: bridge
```

### å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f fileserver

# åœæ­¢æœåŠ¡
docker-compose down
```

---

## ğŸ” æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“è¿æ¥æ± 

```python
# server/database.py
self.pool = await asyncpg.create_pool(
    host=self.config.get("host", "localhost"),
    port=self.config.get("port", 5432),
    database=self.config.get("database", "file_server"),
    user=self.config.get("user", "postgres"),
    password=self.config.get("password", ""),
    min_size=5,      # æœ€å°è¿æ¥æ•°
    max_size=20,     # æœ€å¤§è¿æ¥æ•°
    command_timeout=30
)
```

### 2. æ–‡ä»¶å»é‡

ç³»ç»Ÿé€šè¿‡æ–‡ä»¶å“ˆå¸Œå®ç°å»é‡ï¼š

```python
# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
existing_doc_id = await db.check_file_exists(file_hash, user_id)
if existing_doc_id:
    # è¿”å›å·²å­˜åœ¨çš„æ–‡æ¡£IDï¼Œé¿å…é‡å¤å¤„ç†
    return {"document_id": existing_doc_id, "status": "exists"}
```

### 3. å¼‚æ­¥å¤„ç†

æ‰€æœ‰IOæ“ä½œä½¿ç”¨async/awaitï¼š

```python
# å¼‚æ­¥ä¸Šä¼ åˆ°MinIO
async with aiohttp.ClientSession() as session:
    await upload_to_minio(session, file_data, filename)

# å¼‚æ­¥æ•°æ®åº“æ“ä½œ
async with db.get_connection() as conn:
    await conn.execute(query, *params)
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### 1. OCRå¤„ç†å¤±è´¥

**é—®é¢˜**ï¼šOCRè¯†åˆ«è¿”å›é”™è¯¯æˆ–è¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥Mistral APIé…ç½®
echo $MISTRAL_API_KEY

# å¢åŠ è¶…æ—¶æ—¶é—´
# åœ¨ä»£ç ä¸­è®¾ç½®æ›´é•¿çš„timeout
async with httpx.AsyncClient(timeout=600) as client:
    ...
```

### 2. MinIOè¿æ¥å¤±è´¥

**é—®é¢˜**ï¼šæ— æ³•è¿æ¥åˆ°MinIOæœåŠ¡

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥MinIOæœåŠ¡çŠ¶æ€
docker ps | grep minio

# æµ‹è¯•è¿æ¥
mc alias set myminio http://localhost:9000 ACCESS_KEY SECRET_KEY
mc ls myminio

# åˆ›å»ºbucket
mc mb myminio/openmonica
```

### 3. å‘é‡ç»´åº¦ä¸åŒ¹é…

**é—®é¢˜**ï¼šåµŒå…¥å‘é‡ç»´åº¦ä¸æ•°æ®åº“é…ç½®ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**ï¼š
```sql
-- æ£€æŸ¥å½“å‰å‘é‡ç»´åº¦
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'components' AND column_name = 'embedding';

-- å¦‚éœ€ä¿®æ”¹ï¼Œéœ€è¦é‡å»ºè¡¨æˆ–ä½¿ç”¨å›ºå®šç»´åº¦
ALTER TABLE chunk_schema.components
ALTER COLUMN embedding TYPE vector(1024);  -- ä¿®æ”¹ä¸ºæ­£ç¡®ç»´åº¦
```

### 4. å†…å­˜å ç”¨è¿‡é«˜

**é—®é¢˜**ï¼šå¤„ç†å¤§æ–‡ä»¶æ—¶å†…å­˜å ç”¨è¿‡é«˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# ä½¿ç”¨æµå¼è¯»å–
async def stream_upload(file_path: str):
    async with aiofiles.open(file_path, 'rb') as f:
        chunk_size = 1024 * 1024  # 1MB
        while True:
            chunk = await f.read(chunk_size)
            if not chunk:
                break
            # å¤„ç†chunk
```

---

## ğŸ“Š ç›‘æ§ä¸æ—¥å¿—

### æ—¥å¿—é…ç½®

ç³»ç»Ÿä½¿ç”¨loguruè¿›è¡Œæ—¥å¿—è®°å½•ï¼š

```python
from loguru import logger

# é…ç½®æ—¥å¿—
logger.add(
    "logs/fileserver_{time}.log",
    rotation="500 MB",
    retention="10 days",
    level="INFO"
)

# è®°å½•æ—¥å¿—
logger.info(f"Processing file: {filename}")
logger.error(f"Error occurred: {error}")
```

### æ€§èƒ½ç›‘æ§

```python
import time

async def monitor_processing(func):
    """è£…é¥°å™¨ï¼šç›‘æ§å¤„ç†æ—¶é—´"""
    async def wrapper(*args, **kwargs):
        start_time = time.time()
        result = await func(*args, **kwargs)
        elapsed = time.time() - start_time
        logger.info(f"{func.__name__} took {elapsed:.2f}s")
        return result
    return wrapper
```

---

## ğŸ§ª æµ‹è¯•

### è¿è¡Œæµ‹è¯•

```bash
# å®‰è£…æµ‹è¯•ä¾èµ–
uv sync --group dev

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œç‰¹å®šæµ‹è¯•
pytest tests/test_file_upload.py

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest --cov=src --cov-report=html
```

### æµ‹è¯•ç¤ºä¾‹

```python
import pytest
from httpx import AsyncClient

@pytest.mark.asyncio
async def test_upload_file():
    async with AsyncClient(base_url="http://localhost:8087") as client:
        with open("test.pdf", "rb") as f:
            response = await client.post(
                "/v1/files",
                files={"file": f},
                data={"user_id": "test-user"}
            )
        assert response.status_code == 200
        assert response.json()["status"] == "success"
```

---

## ğŸ“„ è®¸å¯è¯

MIT License - è¯¦è§é¡¹ç›®æ ¹ç›®å½•LICENSEæ–‡ä»¶

---

## ğŸ”— ç›¸å…³é“¾æ¥

- [é¡¹ç›®ä¸»é¡µ](../../README.md)
- [æ•°æ®åº“æ¨¡å—](../openmonica_sql/README.md)
- [ç”¨æˆ·ç®¡ç†æœåŠ¡](../OpenMonica_UserManagement/README.md)
- [æ ¸å¿ƒé—®ç­”æœåŠ¡](../OpenMonica_main/README.md)

---

<div align="center">

**[â¬† è¿”å›é¡¶éƒ¨](#openmonica-fileserver---æ–‡æ¡£å¤„ç†ä¸çŸ¥è¯†åº“ç®¡ç†æœåŠ¡)**

</div>
